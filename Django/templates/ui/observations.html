{% extends "base.html" %}

{% block content %}
<main>
  <h1 class="page-title" style="font-size:1.4rem;">Observations</h1>

  <!-- Filter bar -->
  <form method="get" class="filterbar">
    <div class="field">
      <label for="q">SSID or BSSID</label>
      <input type="text" id="q" name="q" value="{{ request.GET.q }}">
    </div>
    <div class="field">
      <label for="device">Device</label>
      <select id="device" name="device">
        <option value="">All devices</option>
        {% for d in devices %}
          <option value="{{ d.id }}"{% if request.GET.device == d.id|stringformat:"s" %} selected{% endif %}>{{ d.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="field">
      <label for="since">Since</label>
      <input type="date" id="since" name="since" value="{{ request.GET.since }}">
    </div>
    <div class="field">
      <label for="until">Until</label>
      <input type="date" id="until" name="until" value="{{ request.GET.until }}">
    </div>
    <div class="field">
      <label>&nbsp;</label>
      <button type="submit">Filter</button>
    </div>
    <div class="field">
      <label>&nbsp;</label>
      <a href="{% url 'observations' %}" class="btn">Reset</a>
    </div>
    <div class="field">
      <label>&nbsp;</label>
      <a href="?{{ keepqs }}&export=csv" class="btn">Export CSV</a>
    </div>
  </form>

  <!-- Top row: unwhitelisted + recent alerts -->
  <div class="obs-top-grid" style="display:flex; gap:1rem; align-items:flex-start; margin-bottom:1rem; flex-wrap:wrap;">
    <!-- Current unwhitelisted (last 10 min) -->
    <div class="obs-block" style="flex:1 1 320px;">
      <h3 style="font-size:0.9rem; margin-bottom:0.25rem;">Current detected unwhitelisted (last 10 min)</h3>

      <!-- mini search for this table -->
      <form method="get" style="margin-bottom:0.4rem; font-size:0.75rem; display:flex; gap:0.3rem; align-items:center;">
        <input type="text" name="flag_q" placeholder="Search SSID/BSSID‚Ä¶" value="{{ flag_q }}" style="max-width:170px;">
        <!-- preserve main filters + other table searches -->
        <input type="hidden" name="q" value="{{ q }}">
        <input type="hidden" name="device" value="{{ selected_device }}">
        <input type="hidden" name="since" value="{{ since }}">
        <input type="hidden" name="until" value="{{ until }}">
        <input type="hidden" name="alert_q" value="{{ alert_q }}">
        <input type="hidden" name="anomaly_q" value="{{ anomaly_q }}">
        <button type="submit" class="btn" style="padding:2px 8px;">Search</button>
      </form>

      <div class="table-wrap" style="overflow-x:auto;">
        <table class="table-tight">
          <thead>
            <tr>
              <th>SSID</th>
              <th>BSSID</th>
              <th>Ch</th>
              <th>Seen</th>
            </tr>
          </thead>
          <tbody>
            {% if flag_page.object_list %}
              {% for o in flag_page.object_list %}
              <tr>
                <td>{{ o.ssid|default:"‚Äî" }}</td>
                <td class="mono">{{ o.bssid }}</td>
                <td>{{ o.channel }}</td>
                <td>{{ o.server_ts|date:"M j, Y, g:i a" }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="4" class="empty">No unwhitelisted APs seen in the last 10 minutes.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% if flag_page.paginator.num_pages > 1 %}
      <div class="pagination" style="margin-top:0.4rem; font-size:0.7rem;">
        {% if flag_page.has_previous %}
          <a href="?flag_page={{ flag_page.previous_page_number }}&{{ keepqs }}">¬´ Prev</a>
        {% else %}
          <span>¬´ Prev</span>
        {% endif %}
        <span>Page {{ flag_page.number }} / {{ flag_page.paginator.num_pages }}</span>
        {% if flag_page.has_next %}
          <a href="?flag_page={{ flag_page.next_page_number }}&{{ keepqs }}">Next ¬ª</a>
        {% else %}
          <span>Next ¬ª</span>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- Recent alerts / observations -->
    <div class="obs-block" style="flex:1 1 320px;">
      <h3 style="font-size:0.9rem; margin-bottom:0.25rem;">Recent alerts / observations</h3>

      <!-- mini search for this table -->
      <form method="get" style="margin-bottom:0.4rem; font-size:0.75rem; display:flex; gap:0.3rem; align-items:center;">
        <input type="text" name="alert_q" placeholder="Search SSID/BSSID‚Ä¶" value="{{ alert_q }}" style="max-width:170px;">
        <input type="hidden" name="q" value="{{ q }}">
        <input type="hidden" name="device" value="{{ selected_device }}">
        <input type="hidden" name="since" value="{{ since }}">
        <input type="hidden" name="until" value="{{ until }}">
        <input type="hidden" name="flag_q" value="{{ flag_q }}">
        <input type="hidden" name="anomaly_q" value="{{ anomaly_q }}">
        <button type="submit" class="btn" style="padding:2px 8px;">Search</button>
      </form>

      <div class="table-wrap" style="overflow-x:auto;">
        <table class="table-tight">
          <thead>
            <tr>
              <th>Time</th>
              <th>SSID</th>
              <th>BSSID</th>
            </tr>
          </thead>
          <tbody>
            {% if alert_page.object_list %}
              {% for o in alert_page.object_list %}
              <tr>
                <td>{{ o.server_ts|date:"M j, Y, g:i a" }}</td>
                <td>{{ o.ssid|default:"‚Äî" }}</td>
                <td class="mono">{{ o.bssid }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="3" class="empty">No recent alerts.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% if alert_page.paginator.num_pages > 1 %}
      <div class="pagination" style="margin-top:0.4rem; font-size:0.7rem;">
        {% if alert_page.has_previous %}
          <a href="?alert_page={{ alert_page.previous_page_number }}&{{ keepqs }}">¬´ Prev</a>
        {% else %}
          <span>¬´ Prev</span>
        {% endif %}
        <span>Page {{ alert_page.number }} / {{ alert_page.paginator.num_pages }}</span>
        {% if alert_page.has_next %}
          <a href="?alert_page={{ alert_page.next_page_number }}&{{ keepqs }}">Next ¬ª</a>
        {% else %}
          <span>Next ¬ª</span>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Big whitelist anomalies / possible evil twins table -->
  <div class="obs-block" style="margin-bottom:1rem;">

    <h3 style="font-size:0.9rem;">Whitelist anomalies / possible evil twins (current)</h3>

    <p style="margin:0 0 8px; color:var(--muted); font-size:0.75rem;">
      These APs are <strong>currently violating</strong> your whitelist rules.
      They stay listed here until they are removed or corrected in the whitelist.
      (Dynamic: if the whitelist is fixed, these will disappear automatically.)
    </p>

    <!-- mini search for anomalies table -->
    <form method="get" style="margin-bottom:0.4rem; font-size:0.75rem; display:flex; gap:0.3rem; align-items:center;">
      <input type="text" name="anomaly_q" placeholder="Search SSID/BSSID‚Ä¶" value="{{ anomaly_q }}" style="max-width:200px;">
      <input type="hidden" name="q" value="{{ q }}">
      <input type="hidden" name="device" value="{{ selected_device }}">
      <input type="hidden" name="since" value="{{ since }}">
      <input type="hidden" name="until" value="{{ until }}">
      <input type="hidden" name="flag_q" value="{{ flag_q }}">
      <input type="hidden" name="alert_q" value="{{ alert_q }}">
      <button type="submit" class="btn" style="padding:2px 8px;">Search</button>
    </form>

    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table-tight">
        <thead>
          <tr>
            <th>Time</th>
            <th>SSID</th>
            <th>BSSID</th>
            <th>Device</th>
            <th>Ch</th>
            <th>Security</th>
            <th>RSN</th>
            <th>AKM</th>
            <th>PMF</th>
            <th>Dynamic status</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          {% if anomaly_rows %}
            {% for o in anomaly_rows %}
              <tr>
                <td>{{ o.server_ts|date:"M j, Y, g:i a" }}</td>
                <td>{{ o.ssid|default:"‚Äî" }}</td>
                <td class="mono">{{ o.bssid }}</td>
                <td>{{ o.device.name }}</td>
                <td>{{ o.channel }}</td>
                <td>{{ o.security|default:"‚Äî" }}</td>
                <td>{{ o.rsn_text|default:"‚Äî" }}</td>
                <td>{{ o.akm_list|default:"‚Äî" }}</td>
                <td>cap={{ o.pmf_capable|yesno:"Y,N" }}, req={{ o.pmf_required|yesno:"Y,N" }}</td>
                <td>{{ o.dynamic_status|default:o.match_status|default:"(none)" }}</td>
                <td><a href="{% url 'observation_detail' o.id %}" class="btn-link">Details</a></td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="11" class="empty">
                No current whitelist anomalies detected.  
                <br>All known SSIDs match their expected security settings and AP properties.
              </td>
            </tr>
          {% endif %}
        </tbody>

      </table>
    </div>

  </div>

  <!-- All detected APs (compact, scrollable) -->
  <div class="obs-block" style="margin-top:16px;">
    <h3 style="font-size:0.9rem;">
      All detected APs
      <small style="color:var(--muted, #666); font-weight:400;">
        Total: {{ page.paginator.count }}
      </small>
    </h3>

    <!-- mini search JUST for the big table (reuses main filters) -->
    <form method="get" style="margin-bottom:0.4rem; font-size:0.75rem; display:flex; gap:0.3rem; align-items:center;">
      <input type="text" name="q" placeholder="Search SSID/BSSID‚Ä¶" value="{{ q }}" style="max-width:220px;">
      <input type="hidden" name="device" value="{{ selected_device }}">
      <input type="hidden" name="since" value="{{ since }}">
      <input type="hidden" name="until" value="{{ until }}">
      <input type="hidden" name="flag_q" value="{{ flag_q }}">
      <input type="hidden" name="alert_q" value="{{ alert_q }}">
      <input type="hidden" name="anomaly_q" value="{{ anomaly_q }}">
      <button type="submit" class="btn" style="padding:2px 8px;">Search</button>
    </form>

    <!-- SCROLL AREA + SMALL FONT -->
    <div class="table-wrap" style="max-height:420px; overflow:auto; font-size:0.75rem;">
      <table class="table-tight" style="table-layout:fixed; font-size:0.72rem;">
        <thead>
          <tr>
            <th style="width:40px;">ID</th>
            <th style="width:120px;">Time</th>
            <th style="width:80px;">Device</th>
            <th style="width:140px;">SSID</th>
            <th style="width:150px;">BSSID</th>
            <th style="width:40px;">Ch</th>
            <th style="width:80px;">RSSI</th>
            <th style="width:90px;">Security</th>
            <th style="width:100px;">RSN</th>
            <th style="width:80px;">AKM</th>
            <th style="width:80px;">PMF</th>
            <th style="width:95px;">Dyn status</th>
            <th style="width:45px;">Flag</th>
            <th style="width:80px;">Chain</th>
            <th style="width:60px;">Integrity</th>
            <th style="width:65px;"></th>
          </tr>
        </thead>
        <tbody>
          {% if page.object_list %}
            {% for o in page.object_list %}
            <tr>
              <td>{{ o.id }}</td>

              <td style="white-space:nowrap;">
                {{ o.server_ts|date:"M j, Y g:i a" }}
              </td>

              <td style="white-space:nowrap;">
                {{ o.device.name|default:"‚Äî" }}
              </td>

              <td class="ellipsis" style="max-width:140px;">
                {{ o.ssid|default:"‚Äî" }}
              </td>

              <td class="mono" style="max-width:150px; overflow:hidden; text-overflow:ellipsis;">
                {{ o.bssid }}
              </td>

              <td style="white-space:nowrap;">{{ o.channel }}</td>

              <td style="white-space:nowrap;">
                {% if o.rssi_best or o.rssi_current %}
                  {{ o.rssi_best|default:"‚Äî" }}/{{ o.rssi_current|default:"‚Äî" }}
                {% else %}
                  ‚Äî
                {% endif %}
              </td>

              <td class="ellipsis" style="max-width:90px;">
                {{ o.security|default:"‚Äî" }}
              </td>

              <td class="ellipsis" style="max-width:100px;">
                {{ o.rsn_text|default:"‚Äî" }}
              </td>

              <td class="ellipsis" style="max-width:80px;">
                {{ o.akm_list|default:"‚Äî" }}
              </td>

              <td style="white-space:nowrap;">
                cap={{ o.pmf_capable|yesno:"Y,N" }},
                req={{ o.pmf_required|yesno:"Y,N" }}
              </td>

              <td class="ellipsis" style="max-width:95px;">
                {{ o.dynamic_status|default:o.match_status|default:"(none)" }}
              </td>

              <td style="white-space:nowrap;">
                {% if o.dynamic_anomaly %}üî•
                {% elif o.dynamic_flagged %}‚ö†Ô∏è
                {% else %}ok
                {% endif %}
              </td>

              <td class="mono" style="max-width:80px; overflow:hidden; text-overflow:ellipsis;">
                {% if o.chain_hex %}
                  {{ o.chain_hex|slice:":16" }}‚Ä¶
                {% else %}
                  ‚Äî
                {% endif %}
              </td>

              <td style="white-space:nowrap;">
                {% if o.integrity_ok %}
                  ‚úÖ
                {% else %}
                  ‚ùå
                {% endif %}
              </td>

              <td style="white-space:nowrap;">
                <a href="{% url 'observation_detail' o.id %}" class="btn-link">
                  Details
                </a>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="16" class="empty">No logs available.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if page.paginator.num_pages > 1 %}
    <div class="pagination" style="font-size:0.7rem;">
      {% if page.has_previous %}
        <a href="?page={{ page.previous_page_number }}&{{ keepqs }}">Previous</a>
      {% else %}
        <span>Previous</span>
      {% endif %}

      <span class="current">Page {{ page.number }} of {{ page.paginator.num_pages }}</span>

      {% if page.has_next %}
        <a href="?page={{ page.next_page_number }}&{{ keepqs }}">Next</a>
      {% else %}
        <span>Next</span>
      {% endif %}
    </div>
    {% endif %}
  </div>

</main>
{% endblock %}
