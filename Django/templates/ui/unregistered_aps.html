{% extends "base.html" %}

{% block content %}
<main>
  <h1 class="page-title" style="font-size:1.4rem;">Unregistered APs (Dynamic)</h1>

  <p style="margin-bottom:0.75rem; color:var(--muted, #777); font-size:0.85rem;">
    This view shows <strong>unique APs</strong> that are currently classified as
    <code>UNREGISTERED_AP</code> by the live whitelist logic.
    Each row is the <strong>latest</strong> observation for that SSID/BSSID pair.
  </p>

  <!-- Search bar -->
  <form method="get" class="filterbar" style="margin-bottom:0.75rem;">
    <div class="field">
      <label for="q">Search (SSID or BSSID)</label>
      <input type="text" id="q" name="q" value="{{ q }}" placeholder="e.g. Hospital or AA:BB:CC:DD:EE:FF">
    </div>
    <div class="field">
      <label>&nbsp;</label>
      <button type="submit">Filter</button>
    </div>
    <div class="field">
      <label>&nbsp;</label>
      <a href="{% url 'unregistered_aps' %}" class="btn">Reset</a>
    </div>
  </form>

  <div class="obs-block" style="margin-top:0.5rem;">
    <h3 style="font-size:0.9rem;">
      Unique unregistered APs
      <small style="color:var(--muted, #666); font-weight:400;">
        Total unique: {{ total_unique }}
      </small>
    </h3>

    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table-tight">
        <thead>
          <tr>
            <th>SSID</th>
            <th>BSSID</th>
            <th>Device</th>
            <th>Ch</th>
            <th>Security</th>
            <th>Last Seen</th>
            <th>Whitelist</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% if page_obj.object_list %}
            {% for o in page_obj.object_list %}
              <tr>
                <td>{{ o.ssid|default:"—" }}</td>
                <td class="mono">{{ o.bssid }}</td>
                <td>
                  {% if o.device %}
                    {{ o.device.name }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>{{ o.channel }}</td>
                <td>{{ o.security|default:"—" }}</td>
                <td>{{ o.server_ts|date:"M j, Y, g:i a" }}</td>

                <!-- Add to whitelist button -->
                <td>
                  <form method="post" action="{% url 'unregistered_add_to_whitelist' o.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-small">Add</button>
                  </form>
                </td>

                <!-- Details link -->
                <td>
                  <a href="{% url 'observation_detail' o.id %}" class="btn-link">Details</a>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="8" class="empty">No unregistered APs found.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if page_obj.paginator.num_pages > 1 %}
      <div class="pagination" style="margin-top:0.5rem;">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}&q={{ q|urlencode }}">Previous</a>
        {% else %}
          <span>Previous</span>
        {% endif %}

        <span class="current">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}&q={{ q|urlencode }}">Next</a>
        {% else %}
          <span>Next</span>
        {% endif %}
      </div>
    {% endif %}
  </div>
</main>
{% endblock %}
