{% extends "base.html" %}

{% block content %}
<main style="padding:1.5rem;">
  <h1 class="page-title" style="font-size:1.4rem; margin-bottom:0.5rem;">
    Whitelist Anomaly Overrides
  </h1>

  <p style="color:var(--muted); font-size:0.85rem; max-width:60rem; margin-bottom:1rem;">
    Use this page to <strong>acknowledge / suppress recurring whitelist anomalies</strong>
    such as intentional lab APs or known “weird” configurations. An active override
    tells the dashboard to stop alerting for that specific SSID/BSSID/status combination.
  </p>

  <div class="dash-row" style="align-items:flex-start; gap:1rem;">

    <!-- LEFT: create override -->
    <div class="obs-block" style="max-width:420px; flex:0 0 420px;">
      <h3 style="margin-bottom:0.5rem;">Add / update override</h3>

      <p style="color:var(--muted); font-size:0.75rem; margin-bottom:0.75rem;">
        Fill in SSID, BSSID and status exactly as shown on the dashboard anomaly card.
      </p>

      <form method="post" class="form-vertical">
        {% csrf_token %}

        <!-- SSID -->
        <div class="field">
          <label>SSID</label>
          {{ form.ssid }}
          {% if form.ssid.errors %}
            <div class="errorlist">{{ form.ssid.errors }}</div>
          {% endif %}
        </div>

        <!-- BSSID -->
        <div class="field">
          <label>BSSID (MAC)</label>
          {{ form.bssid }}
          {% if form.bssid.errors %}
            <div class="errorlist">{{ form.bssid.errors }}</div>
          {% endif %}
        </div>

        <!-- Status -->
        <div class="field">
          <label>Status</label>
          {{ form.status }}
          <div class="help">
            Example: <code>CHANNEL_MISMATCH</code>, <code>SECURITY_MISMATCH</code>,
            <code>KNOWN_SSID_BUT_UNEXPECTED_AP</code>.
          </div>
          {% if form.status.errors %}
            <div class="errorlist">{{ form.status.errors }}</div>
          {% endif %}
        </div>

        <!-- Active checkbox -->
        <div class="field">
          <label style="display:flex; align-items:center; gap:0.35rem;">
            {{ form.active }}
            <span>Override is active</span>
          </label>
          <div class="help">
            Uncheck to keep the record but stop suppressing alerts.
          </div>
          {% if form.active.errors %}
            <div class="errorlist">{{ form.active.errors }}</div>
          {% endif %}
        </div>

        <!-- Reason -->
        <div class="field">
          <label>Reason / notes</label>
          {{ form.reason }}
          <div class="help">
            Short explanation — e.g. “lab AP”, “temporary vendor AP”.
          </div>
          {% if form.reason.errors %}
            <div class="errorlist">{{ form.reason.errors }}</div>
          {% endif %}
        </div>

        {% if form.non_field_errors %}
          <div class="errorlist">{{ form.non_field_errors }}</div>
        {% endif %}

        <div style="margin-top:0.75rem;">
          <button type="submit">Save override</button>
        </div>
      </form>
    </div>

    <!-- RIGHT: list overrides -->
    <div class="obs-block" style="flex:1;">
      <h3 style="margin-bottom:0.5rem;">
        Existing overrides
        <span style="float:right; font-size:0.75rem; color:var(--muted);">
          Total: {{ overrides|length }}
        </span>
      </h3>

      <p style="color:var(--muted); font-size:0.75rem;">
        Active overrides suppress matching whitelist anomalies. Inactive rows are kept for audit.
      </p>

      <div class="table-wrap">
        <table class="table-tight">
          <thead>
            <tr>
              <th>SSID</th>
              <th>BSSID</th>
              <th>Status</th>
              <th>Active</th>
              <th>Created by</th>
              <th>Created at</th>
              <th>Reason</th>
              <th></th>
            </tr>
          </thead>

          <tbody>
            {% if overrides %}
              {% for o in overrides %}
                <tr {% if not o.active %}style="opacity:0.6;"{% endif %}>
                  <td class="ellipsis">{{ o.ssid|default:"—" }}</td>
                  <td class="mono ch-16">{{ o.bssid|default:"—" }}</td>
                  <td class="mono">{{ o.status|default:"—" }}</td>

                  <td>
                    {% if o.active %}
                      <span class="badge badge-up">active</span>
                    {% else %}
                      <span class="badge badge-down">inactive</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if o.created_by %}
                      {{ o.created_by.get_full_name|default:o.created_by.username }}
                    {% else %}
                      —
                    {% endif %}
                  </td>

                  <td style="white-space:nowrap;">
                    {{ o.created_at|date:"M j, Y, g:i a" }}
                  </td>

                  <td class="ellipsis" title="{{ o.reason }}">
                    {{ o.reason|default:"—" }}
                  </td>

                  <td style="white-space:nowrap;">
                    <a href="{% url 'anomaly_override_edit' o.id %}" class="btn-link">
                      Edit
                    </a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="8" class="empty">
                  No overrides defined yet.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</main>
{% endblock %}
