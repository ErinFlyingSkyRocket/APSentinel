{% extends "base.html" %}

{% block content %}
<main style="padding:1.5rem; max-width:1600px; margin:0 auto;">
  <h1 class="page-title" style="font-size:1.4rem; margin-bottom:0.75rem;">
    AP / Device Activity Analysis
  </h1>

  <p style="color:var(--muted); font-size:0.85rem; max-width:60rem; margin-bottom:1rem;">
    Analyse when an access point or device was observed over time. Filter by device / SSID / BSSID
    and time range, then inspect the timeline, detailed AP properties, any long gaps
    (possible downtime windows), and changes in radio properties.
  </p>

  <!-- Filters -->
  <form method="get" class="filterbar"
        style="grid-template-columns: 1.2fr 1.2fr 1.2fr 0.9fr 0.9fr 0.6fr auto;">
    <div class="field">
      <label for="device">Device</label>
      <select name="device" id="device">
        <option value="">-- any --</option>
        {% for d in devices %}
          <option value="{{ d.id }}" {% if device_id|default:'' == d.id|stringformat:"s" %}selected{% endif %}>
            {{ d.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label for="ssid">SSID (exact)</label>
      <input type="text" id="ssid" name="ssid" value="{{ ssid }}" placeholder="e.g. HospitalWifi">
    </div>

    <div class="field">
      <label for="bssid">BSSID (MAC)</label>
      <input type="text" id="bssid" name="bssid" value="{{ bssid }}" placeholder="AA:BB:CC:DD:EE:FF">
    </div>

    <div class="field">
      <label for="since">From</label>
      <input type="datetime-local" id="since" name="since"
             value="{{ since|date:'Y-m-d\\TH:i' }}">
    </div>

    <div class="field">
      <label for="until">To</label>
      <input type="datetime-local" id="until" name="until"
             value="{{ until|date:'Y-m-d\\TH:i' }}">
    </div>

    <div class="field">
      <label for="hours">Lookback (fallback hours)</label>
      <input type="number" id="hours" name="hours" value="{{ hours_default }}" min="1" max="168">
    </div>

    <div class="field">
      <label>&nbsp;</label>
      <button type="submit">Apply</button>
    </div>
  </form>

  <div style="margin-bottom:0.5rem;">
    <a href="{% url 'ap_activity' %}" class="btn-link">Reset all filters</a>
  </div>

  <!-- MAIN TWO-COLUMN LAYOUT -->
  <div class="dash-row" style="margin-top:0.25rem; align-items:stretch; gap:1rem;">
    <!-- LEFT: AP list -->
    <div class="obs-block"
         style="flex:0 0 40%; max-height:calc(100vh - 260px); display:flex; flex-direction:column;">
      <div style="padding:0.75rem 0.9rem;">
        <h3 style="margin:0 0 0.25rem; font-size:0.9rem;">APs in selected window</h3>
        <p style="margin:0; color:var(--muted); font-size:0.75rem;">
          Time range:
          {{ since|date:"M j, Y g:i a" }} – {{ until|date:"M j, Y g:i a" }} (server time)
        </p>
      </div>

      <!-- SCROLLABLE list of APs (fills card height, then scrolls) -->
      <div class="table-wrap"
           style="flex:1 1 auto; overflow-y:auto; overflow-x:hidden;">
        <table class="table-tight" style="table-layout:fixed; width:100%;">
          <thead>
            <tr>
              <th>SSID</th>
              <th style="width:11rem;">BSSID</th>
              <th style="width:3.5rem;">Ch</th>
              <th style="width:4.5rem; text-align:right;">Count</th>
              <th style="width:70px;"></th>
              <th style="width:140px; text-align:right;">Status</th>
            </tr>
          </thead>
          <tbody>
            {% if ap_list %}
              {% for ap in ap_list %}
                <tr {% if ap.bssid == current_bssid %}style="background:#0e1422;"{% endif %}>
                  <!-- SSID truncated if long -->
                  <td class="ellipsis">
                    {{ ap.ssid|default:"&lt;hidden&gt;"|safe }}
                  </td>
                  <!-- Wider BSSID column, no extra width class -->
                  <td class="mono" style="white-space:nowrap;">
                    {{ ap.bssid }}
                  </td>
                  <td>{{ ap.channel|default:"—" }}</td>
                  <td class="r" style="text-align:right;">{{ ap.count }}</td>
                  <td style="white-space:nowrap; text-align:right;">
                    <a href="?device={{ device_id }}&ssid={{ ssid|urlencode }}&bssid={{ ap.bssid }}&hours={{ hours_default }}&since={{ since|date:'Y-m-d\\TH:i' }}&until={{ until|date:'Y-m-d\\TH:i' }}"
                       class="btn-link">
                      Focus
                    </a>
                  </td>
                  <td style="text-align:right;">
                    {% if ap.dynamic_anomaly %}
                      <span class="badge badge-down">
                        {{ ap.dynamic_status|default:"ANOMALY" }}
                      </span>
                    {% elif ap.dynamic_status %}
                      {% if ap.dynamic_status == "WHITELISTED_STRONG" or ap.dynamic_status == "WHITELISTED_WEAK" %}
                        <span class="badge badge-up">{{ ap.dynamic_status }}</span>
                      {% else %}
                        <span class="badge badge-down">{{ ap.dynamic_status }}</span>
                      {% endif %}
                    {% else %}
                      <span class="badge badge-up">OK</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="6" class="empty">No observations in this window.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT: Timeline + details + gaps (no internal scroll, like before) -->
    <div class="obs-block" style="flex:1;">
      <div style="padding:0.75rem 0.9rem;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:0.5rem;">
          <div>
            <h3 style="margin:0 0 0.25rem; font-size:0.9rem;">
              Timeline for
              {% if current_bssid %}
                <span class="mono">{{ current_bssid }}</span>
              {% else %}
                (no AP selected)
              {% endif %}
            </h3>
            {% if current_bssid %}
              <p style="margin:0; color:var(--muted); font-size:0.75rem;">
                SSID: {{ current_ssid|default:"&lt;hidden&gt;"|safe }},
                Device: {{ current_device_name }},
                Resolution:
                <select id="timelineMode" style="font-size:0.75rem; padding:0.05rem 0.3rem; margin-left:0.25rem;">
                  <option value="minute">Per minute</option>
                  <option value="hour">Per hour (24h)</option>
                  <option value="day">Per day (calendar)</option>
                </select>
                <span id="hourDayWrapper" style="margin-left:0.5rem; display:none;">
                  Day:
                  <select id="hourDaySelect" style="font-size:0.75rem; padding:0.05rem 0.3rem;"></select>
                </span>
              </p>
            {% endif %}
          </div>
          {% if current_bssid %}
            <a href="?device={{ device_id }}&ssid={{ ssid|urlencode }}&hours={{ hours_default }}&since={{ since|date:'Y-m-d\\TH:i' }}&until={{ until|date:'Y-m-d\\TH:i' }}"
               class="btn-link">
              Reset focus
            </a>
          {% endif %}
        </div>
      </div>

      {% if current_bssid and ap_stats %}
        <!-- AP details -->
        <div style="padding:0 0.9rem 0.4rem;">
          <table class="table-tight" style="font-size:0.78rem; margin-top:0;">
            <tbody>
              <tr>
                <th>SSID</th>
                <td>{{ current_meta.ssid|default:"&lt;hidden&gt;"|safe }}</td>
                <th>BSSID</th>
                <td class="mono">{{ current_meta.bssid }}</td>
              </tr>
              <tr>
                <th>OUI</th>
                <td class="mono">{{ current_meta.oui|default:"—" }}</td>
                <th>Channel</th>
                <td>{{ current_meta.channel|default:"—" }}</td>
              </tr>
              <tr>
                <th>Security</th>
                <td>{{ current_meta.security|default:"—" }}</td>
                <th>RSN (group/pair)</th>
                <td>
                  {{ current_meta.rsn_group|default:"—" }} /
                  {{ current_meta.rsn_pair|default:"—" }}
                </td>
              </tr>
              <tr>
                <th>AKM</th>
                <td>{{ current_meta.akm|default:"—" }}</td>
                <th>PMF</th>
                <td>{{ current_meta.pmf|default:"—" }}</td>
              </tr>
              <tr>
                <th>Dynamic status</th>
                <td colspan="3">
                  {% if current_meta.dynamic_anomaly %}
                    <span class="badge badge-down">
                      {{ current_meta.dynamic_status|default:"ANOMALY" }}
                    </span>
                  {% elif current_meta.dynamic_status %}
                    {% if current_meta.dynamic_status == "WHITELISTED_STRONG" or current_meta.dynamic_status == "WHITELISTED_WEAK" %}
                      <span class="badge badge-up">{{ current_meta.dynamic_status }}</span>
                    {% else %}
                      <span class="badge badge-down">{{ current_meta.dynamic_status }}</span>
                    {% endif %}
                  {% else %}
                    <span class="badge badge-up">OK</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <th>First seen</th>
                <td>{{ ap_stats.first_seen|date:"M j, Y g:i a" }}</td>
                <th>Last seen</th>
                <td>{{ ap_stats.last_seen|date:"M j, Y g:i a" }}</td>
              </tr>
              <tr>
                <th># observations</th>
                <td>{{ ap_stats.count }}</td>
                <th># devices</th>
                <td>{{ device_count }}</td>
              </tr>
              <tr>
                <th>RSSI min / max</th>
                <td>
                  {% if ap_stats.min_rssi != None %}
                    {{ ap_stats.min_rssi }} / {{ ap_stats.max_rssi }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <th>RSSI avg</th>
                <td>
                  {% if ap_stats.avg_rssi != None %}
                    {{ ap_stats.avg_rssi|floatformat:1 }}
                  {% else %}
                    —
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Property drift (first vs last) -->
        {% if property_drift %}
          <div style="padding:0 0.9rem 0.4rem;">
            <h4 style="font-size:0.85rem; margin:0 0 0.25rem;">
              Property changes for this BSSID (first vs last in window)
            </h4>
            <div class="table-wrap">
              <table class="table-tight">
                <thead>
                  <tr>
                    <th>Property</th>
                    <th>First seen</th>
                    <th>Last seen</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in property_drift %}
                    <tr>
                      <td>{{ row.label }}</td>
                      <td>{{ row.old }}</td>
                      <td>{{ row.new }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}

        <!-- Same-SSID siblings -->
        {% if ssid_siblings %}
          <div style="padding:0 0.9rem 0.4rem;">
            <h4 style="font-size:0.85rem; margin:0 0 0.25rem;">
              Other APs with same SSID ({{ current_ssid }}) in this window
            </h4>
            <div class="table-wrap">
              <table class="table-tight">
                <thead>
                  <tr>
                    <th>BSSID</th>
                    <th>Count</th>
                    <th>Last seen</th>
                    <th>Ch</th>
                    <th>Security</th>
                    <th>RSN</th>
                    <th>AKM</th>
                    <th>PMF</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in ssid_siblings %}
                    <tr>
                      <td class="mono">{{ s.bssid }}</td>
                      <td class="r">{{ s.count }}</td>
                      <td>{{ s.last_seen|date:"M j, Y g:i a" }}</td>
                      <td>{{ s.channel|default:"—" }}</td>
                      <td>{{ s.security|default:"—" }}</td>
                      <td>{{ s.rsn_group|default:"—" }} / {{ s.rsn_pair|default:"—" }}</td>
                      <td>{{ s.akm|default:"—" }}</td>
                      <td>{{ s.pmf|default:"—" }}</td>
                      <td>
                        {% if s.dynamic_anomaly %}
                          <span class="badge badge-down">
                            {{ s.dynamic_status|default:"ANOMALY" }}
                          </span>
                        {% elif s.dynamic_status %}
                          {% if s.dynamic_status == "WHITELISTED_STRONG" or s.dynamic_status == "WHITELISTED_WEAK" %}
                            <span class="badge badge-up">{{ s.dynamic_status }}</span>
                          {% else %}
                            <span class="badge badge-down">{{ s.dynamic_status }}</span>
                          {% endif %}
                        {% else %}
                          <span class="badge badge-up">OK</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}
      {% endif %}

      <!-- Timeline chart -->
      <div style="padding:0 0.9rem 0.5rem;">
        <canvas id="apTimelineChart" style="width:100%; max-height:260px;"></canvas>
      </div>

      <!-- NEW: Evil-twin frequency by day -->
      <div id="evilTwinBlock" style="padding:0 0.9rem 0.25rem; display:none;">
        <h4 style="font-size:0.85rem; margin:0 0 0.25rem;">
          Evil-twin anomalies by day
        </h4>
        <p style="color:var(--muted); font-size:0.75rem; margin:0 0 0.5rem;">
          Each bar shows how many evil-twin-style whitelist anomalies this AP had on that day.
        </p>
        <canvas id="evilTwinDayChart" style="width:100%; max-height:220px;"></canvas>
      </div>

      <!-- NEW: Per-hour RSSI view for selected day -->
      <div id="evilTwinHourBlock" style="padding:0.25rem 0.9rem 0.75rem; display:none;">
        <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.25rem;">
          <label for="evilDaySelect" style="font-size:0.8rem; color:var(--muted);">
            Day:
          </label>
          <select id="evilDaySelect" style="font-size:0.8rem; padding:0.1rem 0.4rem;"></select>
        </div>
        <canvas id="evilTwinHourChart" style="width:100%; max-height:220px;"></canvas>
        <p style="color:var(--muted); font-size:0.7rem; margin-top:0.25rem;">
          Bars show evil-twin detections per hour for the selected day. Hover to see average RSSI (dBm).
        </p>
      </div>

      <div style="padding:0.5rem 0.9rem 0.9rem;">
        <h4 style="font-size:0.85rem; margin:0 0 0.25rem;">
          Gaps &amp; anomaly windows (no detections &gt; {{ gap_threshold_minutes }} min)
        </h4>
        <div class="table-wrap">
          <table class="table-tight">
            <thead>
              <tr>
                <th>Gap start</th>
                <th>Gap end</th>
                <th>Duration (min)</th>
              </tr>
            </thead>
            <tbody>
              {% if gaps %}
                {% for g in gaps %}
                  <tr>
                    <td>{{ g.start|date:"M j, Y g:i a" }}</td>
                    <td>{{ g.end|date:"M j, Y g:i a" }}</td>
                    <td class="r">{{ g.minutes }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="3" class="empty">No significant gaps detected.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Timeline chart: minute / hour (per-day 24h) / day, count + avg RSSI -->
<script>
  (function() {
    const minuteLabels = {{ chart_labels_json|safe }};
    const minuteCounts = {{ chart_values_json|safe }};
    const minuteRssi   = {{ chart_rssi_json|default:"[]"|safe }};

    // NEW: 24h-per-day structure for hour mode
    const hourSeriesByDay = {{ hour_series_by_day_json|default:"{}"|safe }};
    const hourDayLabels   = {{ hour_day_labels_json|default:"[]"|safe }};

    const dayLabels = {{ chart_day_labels_json|default:"[]"|safe }};
    const dayCounts = {{ chart_day_counts_json|default:"[]"|safe }};
    const dayRssi   = {{ chart_day_rssi_json|default:"[]"|safe }};

    const canvas      = document.getElementById('apTimelineChart');
    const modeSelect  = document.getElementById('timelineMode');
    const hourWrapper = document.getElementById('hourDayWrapper');
    const hourSelect  = document.getElementById('hourDaySelect');

    if (!canvas) return;

    // populate hour-day selector
    if (hourSelect && Array.isArray(hourDayLabels) && hourDayLabels.length) {
      hourDayLabels.forEach(function(d, idx) {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        if (idx === hourDayLabels.length - 1) {
          opt.selected = true;
        }
        hourSelect.appendChild(opt);
      });
    }

    let currentMode = 'minute';
    // default hour-day: last available date
    let currentHourDay = (hourDayLabels.length ? hourDayLabels[hourDayLabels.length - 1] : null);

    if (!minuteLabels.length && (hourDayLabels.length && hourSeriesByDay[currentHourDay])) {
      currentMode = 'hour';
    }
    if (!minuteLabels.length && !hourDayLabels.length && dayLabels.length) {
      currentMode = 'day';
    }
    if (modeSelect) {
      modeSelect.value = currentMode;
    }

    function toggleHourControls() {
      if (!hourWrapper) return;
      hourWrapper.style.display = (currentMode === 'hour' && hourDayLabels.length) ? '' : 'none';
    }
    toggleHourControls();

    function getDataForCurrentMode() {
      if (currentMode === 'hour') {
        if (!currentHourDay || !hourSeriesByDay[currentHourDay]) {
          // fallback to last available day
          if (hourDayLabels.length) {
            currentHourDay = hourDayLabels[hourDayLabels.length - 1];
          }
        }
        const series = hourSeriesByDay[currentHourDay] || {};
        return {
          labels: series.hour_labels || [],
          counts: series.counts || [],
          rssi:   series.avg_rssi || []
        };
      }
      if (currentMode === 'day') {
        return { labels: dayLabels, counts: dayCounts, rssi: dayRssi };
      }
      return { labels: minuteLabels, counts: minuteCounts, rssi: minuteRssi };
    }

    const initial = getDataForCurrentMode();
    if (!initial.labels.length) return;

    const chart = new Chart(canvas, {
      type: 'line',
      data: {
        labels: initial.labels,
        datasets: [
          {
            label: 'Observations',
            data: initial.counts,
            fill: false,
            tension: 0.25,
            yAxisID: 'yCount'
          },
          {
            label: 'Avg RSSI (dBm)',
            data: initial.rssi,
            fill: false,
            tension: 0.25,
            yAxisID: 'yRssi'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: { display: true, text: 'Time' },
            ticks: {
              maxTicksLimit: 8,
              callback: function(value) {
                const raw = this.getLabelForValue(value);
                if (currentMode === 'day') {
                  // YYYY-MM-DD
                  return raw;
                }
                if (currentMode === 'hour') {
                  // 0..23
                  return raw + ':00';
                }
                // minute mode: YYYY-MM-DDTHH:MM:SS → MM-DD HH:MM
                return raw.replace('T', ' ').slice(5, 16);
              }
            }
          },
          yCount: {
            position: 'left',
            beginAtZero: true,
            title: { display: true, text: '# detections' },
            ticks: { precision: 0 }
          },
          yRssi: {
            position: 'right',
            title: { display: true, text: 'RSSI (dBm)' },
            suggestedMin: -100,
            suggestedMax: -30,
            reverse: true
          }
        },
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              title: function(items) {
                const raw = items[0].label;
                if (currentMode === 'day') {
                  return raw;
                }
                if (currentMode === 'hour') {
                  return 'Hour ' + raw + ':00–' + raw + ':59' +
                         (currentHourDay ? (' on ' + currentHourDay) : '');
                }
                return raw.replace('T', ' ');
              }
            }
          }
        }
      }
    });

    if (modeSelect) {
      modeSelect.addEventListener('change', function() {
        currentMode = this.value;
        toggleHourControls();
        const d = getDataForCurrentMode();
        chart.data.labels = d.labels;
        chart.data.datasets[0].data = d.counts;
        chart.data.datasets[1].data = d.rssi;
        chart.update();
      });
    }

    if (hourSelect) {
      hourSelect.addEventListener('change', function() {
        currentHourDay = this.value;
        if (currentMode === 'hour') {
          const d = getDataForCurrentMode();
          chart.data.labels = d.labels;
          chart.data.datasets[0].data = d.counts;
          chart.data.datasets[1].data = d.rssi;
          chart.update();
        }
      });
    }
  })();
</script>

<!-- NEW: Evil-twin per-day and per-hour RSSI charts -->
<script>
  (function() {
    const dayLabels = {{ evil_day_labels_json|default:"[]"|safe }};
    const dayCounts = {{ evil_day_counts_json|default:"[]"|safe }};
    const perDay = {{ evil_series_by_day_json|default:"{}"|safe }};

    const block = document.getElementById('evilTwinBlock');
    const hourBlock = document.getElementById('evilTwinHourBlock');
    const dayCanvas = document.getElementById('evilTwinDayChart');
    const hourCanvas = document.getElementById('evilTwinHourChart');
    const daySelect = document.getElementById('evilDaySelect');

    // No evil-twin data for this AP/window
    if (!block || !dayCanvas || !Array.isArray(dayLabels) || !dayLabels.length) {
      return;
    }

    // Show blocks once we confirm there is data
    block.style.display = '';
    if (hourBlock) {
      hourBlock.style.display = '';
    }

    // Populate day selector
    if (daySelect) {
      dayLabels.forEach(function(d, idx) {
        const cfg = perDay[d] || {};
        const total = cfg.total != null ? cfg.total : (dayCounts[idx] || 0);
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d + ' (' + total + ' hits)';
        if (idx === dayLabels.length - 1) {
          opt.selected = true;
        }
        daySelect.appendChild(opt);
      });
    }

    // Per-day bar chart
    const dayChart = new Chart(dayCanvas, {
      type: 'bar',
      data: {
        labels: dayLabels,
        datasets: [{
          label: 'Evil-twin detections per day',
          data: dayCounts,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: { display: true, text: 'Day' },
          },
          y: {
            title: { display: true, text: 'Detections' },
            beginAtZero: true,
            ticks: { precision: 0 }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                const v = ctx.parsed.y || 0;
                return v + ' evil-twin detections';
              }
            }
          }
        }
      }
    });

    let hourChart = null;

    function buildHourChart(day) {
      if (!hourCanvas || !perDay[day]) return;

      const cfg = perDay[day];
      const hourLabels = cfg.hour_labels || [];
      const counts = cfg.counts || [];
      const avgRssi = cfg.avg_rssi || [];

      if (hourChart) {
        hourChart.destroy();
      }

      hourChart = new Chart(hourCanvas, {
        type: 'bar',
        data: {
          labels: hourLabels,
          datasets: [{
            label: 'Evil-twin detections per hour',
            data: counts,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: 'Hour of day' },
            },
            y: {
              title: { display: true, text: 'Detections' },
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: function(items) {
                  const h = items[0].label;
                  return 'Hour ' + h + ':00–' + h + ':59';
                },
                label: function(ctx) {
                  const v = ctx.parsed.y || 0;
                  const hIndex = ctx.dataIndex;
                  const rssi = avgRssi[hIndex];
                  if (rssi !== null && rssi !== undefined) {
                    return v + ' detections, avg RSSI ' + rssi + ' dBm';
                  }
                  return v + ' detections';
                }
              }
            }
          }
        }
      });
    }

    const initialDay =
      (daySelect && daySelect.value) ||
      (dayLabels.length ? dayLabels[dayLabels.length - 1] : null);

    if (initialDay) {
      buildHourChart(initialDay);
    }

    if (daySelect) {
      daySelect.addEventListener('change', function() {
        buildHourChart(this.value);
      });
    }
  })();
</script>
{% endblock %}
