{% extends "base.html" %}

{% block content %}
<main style="padding:1.5rem;">
  <h1 class="page-title" style="font-size:1.4rem; margin-bottom:0.75rem;">
    AP / Device Activity Analysis
  </h1>

  <p style="color:var(--muted); font-size:0.85rem; max-width:60rem; margin-bottom:1rem;">
    Analyse when an access point or device was observed over time. Filter by device / SSID / BSSID
    and time range, then inspect the timeline, detailed AP properties, any long gaps
    (possible downtime windows), and changes in radio properties.
  </p>

  <!-- Filters -->
  <form method="get" class="filterbar"
        style="grid-template-columns: 1.2fr 1.2fr 1.2fr 0.9fr 0.9fr 0.6fr auto;">
    <div class="field">
      <label for="device">Device</label>
      <select name="device" id="device">
        <option value="">-- any --</option>
        {% for d in devices %}
          <option value="{{ d.id }}" {% if device_id|default:'' == d.id|stringformat:"s" %}selected{% endif %}>
            {{ d.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label for="ssid">SSID (exact)</label>
      <input type="text" id="ssid" name="ssid" value="{{ ssid }}" placeholder="e.g. HospitalWifi">
    </div>

    <div class="field">
      <label for="bssid">BSSID (MAC)</label>
      <input type="text" id="bssid" name="bssid" value="{{ bssid }}" placeholder="AA:BB:CC:DD:EE:FF">
    </div>

    <div class="field">
      <label for="since">From</label>
      <input type="datetime-local" id="since" name="since"
             value="{{ since|date:'Y-m-d\\TH:i' }}">
    </div>

    <div class="field">
      <label for="until">To</label>
      <input type="datetime-local" id="until" name="until"
             value="{{ until|date:'Y-m-d\\TH:i' }}">
    </div>

    <div class="field">
      <label for="hours">Lookback (fallback hours)</label>
      <input type="number" id="hours" name="hours" value="{{ hours_default }}" min="1" max="168">
    </div>

    <div class="field">
      <label>&nbsp;</label>
      <button type="submit">Apply</button>
    </div>
  </form>

  <div style="margin-bottom:0.5rem;">
    <a href="{% url 'ap_activity' %}" class="btn-link">Reset all filters</a>
  </div>

  <div class="dash-row" style="margin-top:0.25rem;">
    <!-- LEFT: AP list -->
    <div class="obs-block">
      <div style="padding:0.75rem 0.9rem;">
        <h3 style="margin:0 0 0.25rem; font-size:0.9rem;">APs in selected window</h3>
        <p style="margin:0; color:var(--muted); font-size:0.75rem;">
          Time range:
          {{ since|date:"M j, Y g:i a" }} – {{ until|date:"M j, Y g:i a" }} (server time)
        </p>
      </div>

      <!-- SCROLLABLE list of APs (approx ~30 rows visible, then scroll) -->
      <div class="table-wrap" style="max-height:520px; overflow-y:auto;">
        <table class="table-tight">
          <thead>
            <tr>
              <th>SSID</th>
              <th>BSSID</th>
              <th>Ch</th>
              <th>Security</th>
              <th>Status</th>
              <th>Count</th>
              <th>Last seen</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% if ap_list %}
              {% for ap in ap_list %}
                <tr {% if ap.bssid == current_bssid %}style="background:#0e1422;"{% endif %}>
                  <td>{{ ap.ssid|default:"&lt;hidden&gt;"|safe }}</td>
                  <td class="mono">{{ ap.bssid }}</td>
                  <td>{{ ap.channel|default:"—" }}</td>
                  <td>{{ ap.security|default:"—" }}</td>
                  <td>
                    {% if ap.dynamic_anomaly %}
                      <span class="badge badge-down">
                        {{ ap.dynamic_status|default:"ANOMALY" }}
                      </span>
                    {% elif ap.dynamic_status %}
                      {% if ap.dynamic_status == "WHITELISTED_STRONG" or ap.dynamic_status == "WHITELISTED_WEAK" %}
                        <span class="badge badge-up">{{ ap.dynamic_status }}</span>
                      {% else %}
                        <span class="badge badge-down">{{ ap.dynamic_status }}</span>
                      {% endif %}
                    {% else %}
                      <span class="badge badge-up">OK</span>
                    {% endif %}
                  </td>
                  <td class="r">{{ ap.count }}</td>
                  <td>{{ ap.last_ts_max|date:"M j, Y g:i a" }}</td>
                  <td>
                    <a href="?device={{ device_id }}&ssid={{ ssid|urlencode }}&bssid={{ ap.bssid }}&hours={{ hours_default }}&since={{ since|date:'Y-m-d\\TH:i' }}&until={{ until|date:'Y-m-d\\TH:i' }}"
                       class="btn-link">
                      Focus
                    </a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="8" class="empty">No observations in this window.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT: Timeline + details + gaps -->
    <div class="obs-block">
      <div style="padding:0.75rem 0.9rem;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:0.5rem;">
          <div>
            <h3 style="margin:0 0 0.25rem; font-size:0.9rem;">
              Timeline for
              {% if current_bssid %}
                <span class="mono">{{ current_bssid }}</span>
              {% else %}
                (no AP selected)
              {% endif %}
            </h3>
            {% if current_bssid %}
              <p style="margin:0; color:var(--muted); font-size:0.75rem;">
                SSID: {{ current_ssid|default:"&lt;hidden&gt;"|safe }},
                Device: {{ current_device_name }},
                Bucket: 1-minute counts of observations
              </p>
            {% endif %}
          </div>
          {% if current_bssid %}
            <a href="?device={{ device_id }}&ssid={{ ssid|urlencode }}&hours={{ hours_default }}&since={{ since|date:'Y-m-d\\TH:i' }}&until={{ until|date:'Y-m-d\\TH:i' }}"
               class="btn-link">
              Reset focus
            </a>
          {% endif %}
        </div>
      </div>

      {% if current_bssid and ap_stats %}
        <!-- AP details -->
        <div style="padding:0 0.9rem 0.4rem;">
          <table class="table-tight" style="font-size:0.78rem; margin-top:0;">
            <tbody>
              <tr>
                <th>SSID</th>
                <td>{{ current_meta.ssid|default:"&lt;hidden&gt;"|safe }}</td>
                <th>BSSID</th>
                <td class="mono">{{ current_meta.bssid }}</td>
              </tr>
              <tr>
                <th>OUI</th>
                <td class="mono">{{ current_meta.oui|default:"—" }}</td>
                <th>Channel</th>
                <td>{{ current_meta.channel|default:"—" }}</td>
              </tr>
              <tr>
                <th>Security</th>
                <td>{{ current_meta.security|default:"—" }}</td>
                <th>RSN (group/pair)</th>
                <td>
                  {{ current_meta.rsn_group|default:"—" }} /
                  {{ current_meta.rsn_pair|default:"—" }}
                </td>
              </tr>
              <tr>
                <th>AKM</th>
                <td>{{ current_meta.akm|default:"—" }}</td>
                <th>PMF</th>
                <td>{{ current_meta.pmf|default:"—" }}</td>
              </tr>
              <tr>
                <th>Dynamic status</th>
                <td colspan="3">
                  {% if current_meta.dynamic_anomaly %}
                    <span class="badge badge-down">
                      {{ current_meta.dynamic_status|default:"ANOMALY" }}
                    </span>
                  {% elif current_meta.dynamic_status %}
                    {% if current_meta.dynamic_status == "WHITELISTED_STRONG" or current_meta.dynamic_status == "WHITELISTED_WEAK" %}
                      <span class="badge badge-up">{{ current_meta.dynamic_status }}</span>
                    {% else %}
                      <span class="badge badge-down">{{ current_meta.dynamic_status }}</span>
                    {% endif %}
                  {% else %}
                    <span class="badge badge-up">OK</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <th>First seen</th>
                <td>{{ ap_stats.first_seen|date:"M j, Y g:i a" }}</td>
                <th>Last seen</th>
                <td>{{ ap_stats.last_seen|date:"M j, Y g:i a" }}</td>
              </tr>
              <tr>
                <th># observations</th>
                <td>{{ ap_stats.count }}</td>
                <th># devices</th>
                <td>{{ device_count }}</td>
              </tr>
              <tr>
                <th>RSSI min / max</th>
                <td>
                  {% if ap_stats.min_rssi != None %}
                    {{ ap_stats.min_rssi }} / {{ ap_stats.max_rssi }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <th>RSSI avg</th>
                <td>
                  {% if ap_stats.avg_rssi != None %}
                    {{ ap_stats.avg_rssi|floatformat:1 }}
                  {% else %}
                    —
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Property drift (first vs last) -->
        {% if property_drift %}
          <div style="padding:0 0.9rem 0.4rem;">
            <h4 style="font-size:0.85rem; margin:0 0 0.25rem;">
              Property changes for this BSSID (first vs last in window)
            </h4>
            <div class="table-wrap">
              <table class="table-tight">
                <thead>
                  <tr>
                    <th>Property</th>
                    <th>First seen</th>
                    <th>Last seen</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in property_drift %}
                    <tr>
                      <td>{{ row.label }}</td>
                      <td>{{ row.old }}</td>
                      <td>{{ row.new }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}

        <!-- Same-SSID siblings -->
        {% if ssid_siblings %}
          <div style="padding:0 0.9rem 0.4rem;">
            <h4 style="font-size:0.85rem; margin:0 0 0.25rem;">
              Other APs with same SSID ({{ current_ssid }}) in this window
            </h4>
            <div class="table-wrap">
              <table class="table-tight">
                <thead>
                  <tr>
                    <th>BSSID</th>
                    <th>Count</th>
                    <th>Last seen</th>
                    <th>Ch</th>
                    <th>Security</th>
                    <th>RSN</th>
                    <th>AKM</th>
                    <th>PMF</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in ssid_siblings %}
                    <tr>
                      <td class="mono">{{ s.bssid }}</td>
                      <td class="r">{{ s.count }}</td>
                      <td>{{ s.last_seen|date:"M j, Y g:i a" }}</td>
                      <td>{{ s.channel|default:"—" }}</td>
                      <td>{{ s.security|default:"—" }}</td>
                      <td>{{ s.rsn_group|default:"—" }} / {{ s.rsn_pair|default:"—" }}</td>
                      <td>{{ s.akm|default:"—" }}</td>
                      <td>{{ s.pmf|default:"—" }}</td>
                      <td>
                        {% if s.dynamic_anomaly %}
                          <span class="badge badge-down">
                            {{ s.dynamic_status|default:"ANOMALY" }}
                          </span>
                        {% elif s.dynamic_status %}
                          {% if s.dynamic_status == "WHITELISTED_STRONG" or s.dynamic_status == "WHITELISTED_WEAK" %}
                            <span class="badge badge-up">{{ s.dynamic_status }}</span>
                          {% else %}
                            <span class="badge badge-down">{{ s.dynamic_status }}</span>
                          {% endif %}
                        {% else %}
                          <span class="badge badge-up">OK</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}
      {% endif %}

      <div style="padding:0 0.9rem 0.5rem;">
        <canvas id="apTimelineChart" style="width:100%; max-height:260px;"></canvas>
      </div>

      <div style="padding:0.5rem 0.9rem 0.9rem;">
        <h4 style="font-size:0.85rem; margin:0 0 0.25rem;">
          Gaps &amp; anomaly windows (no detections &gt; {{ gap_threshold_minutes }} min)
        </h4>
        <div class="table-wrap">
          <table class="table-tight">
            <thead>
              <tr>
                <th>Gap start</th>
                <th>Gap end</th>
                <th>Duration (min)</th>
              </tr>
            </thead>
            <tbody>
              {% if gaps %}
                {% for g in gaps %}
                  <tr>
                    <td>{{ g.start|date:"M j, Y g:i a" }}</td>
                    <td>{{ g.end|date:"M j, Y g:i a" }}</td>
                    <td class="r">{{ g.minutes }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="3" class="empty">No significant gaps detected.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function() {
    const labels = {{ chart_labels_json|safe }};
    const values = {{ chart_values_json|safe }};

    const canvas = document.getElementById('apTimelineChart');
    if (!canvas || !labels.length) return;

    new Chart(canvas, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Observations per minute',
          data: values,
          fill: false,
          tension: 0.25
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: { display: true, text: 'Time' },
            ticks: {
              maxTicksLimit: 8,
              callback: function(value, index, ticks) {
                const raw = this.getLabelForValue(value);
                return raw.replace('T', ' ').slice(5, 16);
              }
            }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: '# detections' },
            ticks: { precision: 0 }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: function(items) {
                const raw = items[0].label;
                return raw.replace('T', ' ');
              }
            }
          }
        }
      }
    });
  })();
</script>
{% endblock %}
