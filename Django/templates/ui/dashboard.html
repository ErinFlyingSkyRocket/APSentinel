{% extends "base.html" %}

{% block content %}
<main>
  <h1 class="page-title" style="font-size:1.4rem;">Dashboard</h1>

  <!-- row 1: stats + ESP32 devices -->
  <div class="dash-row">
    <!-- Key stats (observations + devices) -->
    <div class="obs-block">
      <h3>Observation & Device Summary</h3>
      <div class="table-wrap">
        <table class="table-tight">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total observations</td>
              <td>{{ total_obs|default:"0" }}</td>
            </tr>
            <tr>
              <td>Devices (active ≤ 1h)</td>
              <td>{{ active_device_count|default:"0" }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ESP32 / sensor devices -->
    <div class="obs-block">
      <h3>ESP32 / Sensor devices</h3>
      <div class="table-wrap">
        <table class="table-tight">
          <thead>
            <tr>
              <th>Device</th>
              <th>Last seen</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for row in device_rows %}
              <tr>
                <td>{{ row.device.name }}</td>
                <td style="white-space:nowrap;">
                  {% if row.last_seen %}
                    {{ row.last_seen|date:"M j, Y, g:i a" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  {% if row.status == "online" %}
                    <span class="badge badge-up">online</span>
                  {% else %}
                    <span class="badge badge-down">offline &gt; 1h</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="3" class="empty">No devices.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- whitelist anomalies / possible evil twin -->
  <div class="obs-block" style="margin-top:16px;">
    <h3>
      Whitelist anomalies / possible evil twin (last 24 hours)
      <span style="float:right; font-size:0.75rem; color:var(--muted);">
        Total: {{ anomalies_critical|length }}
      </span>
    </h3>
    <p style="margin:0 0 8px; color:var(--muted); font-size:0.75rem;">
      These are APs where the SSID is known/whitelisted but some property changed
      (channel, security, or unexpected BSSID). Review these first.
    </p>
    <div class="table-wrap">
      <table class="table-tight">
        <thead>
          <tr>
            <th>SSID</th>
            <th>BSSID</th>
            <th>Device</th>
            <th>Ch</th>
            <th>Security</th>
            <th>RSN</th>
            <th>AKM</th>
            <th>PMF</th>
            <th>Dynamic status</th>
            <th>Last seen</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% if anomalies_critical %}
            {% for o in anomalies_critical %}
              <tr>
                <td class="ellipsis">{{ o.ssid|default:"—" }}</td>
                <td class="mono ch-16">{{ o.bssid }}</td>
                <td>{{ o.device.name }}</td>
                <td>{{ o.channel }}</td>
                <td>{{ o.security|default:"—" }}</td>
                <td>{{ o.rsn_text|default:"—" }}</td>
                <td>{{ o.akm_list|default:"—" }}</td>
                <td>
                  cap={{ o.pmf_capable|yesno:"Y,N" }},
                  req={{ o.pmf_required|yesno:"Y,N" }}
                </td>
                <td>{{ o.dynamic_status|default:o.match_status|default:"(none)" }}</td>
                <td style="white-space:nowrap;">
                  {{ o.server_ts|date:"M j, Y, g:i a" }}
                </td>
                <td>
                  <a class="btn-link" href="{% url 'observation_detail' o.id %}">Details</a>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="11" class="empty">
                No whitelist anomalies detected in the last 24 hours.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- row 2: alert logs + unwhitelisted (side-by-side) -->
  <div class="dash-row" style="margin-top:14px;">
    <!-- Alert logs / recent observations -->
    <div class="obs-block">
      <h3>Alert logs / recent observations (latest 20)</h3>
      <div class="table-wrap">
        <table class="table-tight">
          <thead>
            <tr>
              <th>Time</th>
              <th>SSID</th>
              <th>BSSID</th>
              <th>Device</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% if recent_alerts %}
              {% for o in recent_alerts %}
                <tr>
                  <td style="white-space:nowrap;">
                    {{ o.server_ts|date:"M j, Y, g:i a" }}
                  </td>
                  <td class="ellipsis">{{ o.ssid|default:"—" }}</td>
                  <td class="mono ch-16">{{ o.bssid }}</td>
                  <td>{{ o.device.name }}</td>
                  <td>
                    <a class="btn-link" href="{% url 'observation_detail' o.id %}">Details</a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="empty">No observations yet.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      <p style="margin:8px 14px 12px; color:var(--muted); font-size:0.7rem;">
        For full filtering and CSV export, go to the
        <a href="{% url 'observations' %}">Observations</a> page.
      </p>
    </div>

    <!-- Unwhitelisted APs (last 10 minutes) -->
    <div class="obs-block">
      <h3>
        Unwhitelisted APs (last 10 minutes)
        <span style="float:right; font-size:0.75rem; color:var(--muted);">
          Total: {{ current_unwhitelisted|length }}
        </span>
      </h3>
      <div class="table-wrap">
        <table class="table-tight">
          <thead>
            <tr>
              <th>SSID</th>
              <th>BSSID</th>
              <th>Dev</th>
              <th>Last seen</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% if current_unwhitelisted %}
              {% for o in current_unwhitelisted %}
                <tr>
                  <td class="ellipsis">{{ o.ssid|default:"—" }}</td>
                  <td class="mono ch-16">{{ o.bssid }}</td>
                  <td>{{ o.device.name }}</td>
                  <td style="white-space:nowrap;">
                    {{ o.server_ts|date:"M j, Y, g:i a" }}
                  </td>
                  <td>
                    <a class="btn-link" href="{% url 'observation_detail' o.id %}">Details</a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="empty">
                  No unwhitelisted APs detected in the last 10 minutes.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</main>
{% endblock %}
