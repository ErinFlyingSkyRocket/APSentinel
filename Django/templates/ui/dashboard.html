{% extends "base.html" %}

{% block content %}
<main>
  <h1 class="page-title" style="font-size:1.4rem;">Dashboard</h1>

  <!-- top cards -->
  <div class="cards" style="max-width:420px; margin-bottom:16px;">
    <div class="card" style="text-align:left;">
      <div style="color:var(--muted); font-size:0.7rem;">Observations</div>
      <div style="font-size:2.4rem; font-weight:600; line-height:1;">{{ total_obs }}</div>
    </div>
    <div class="card" style="text-align:left;">
      <div style="color:var(--muted); font-size:0.7rem;">Devices (active ≤ 1h)</div>
      <div style="font-size:2.4rem; font-weight:600; line-height:1;">{{ active_device_count }}</div>
    </div>
  </div>

  <!-- row: devices + unwhitelisted -->
  <div class="dash-row" style="display:flex; gap:14px; flex-wrap:wrap; align-items:flex-start;">
    <!-- ESP32 / sensor devices -->
    <div class="obs-block" style="flex:1 1 360px; min-width:320px;">
      <h3>ESP32 / Sensor devices</h3>
      <div class="table-wrap">
        <table class="table-tight">
          <thead>
            <tr>
              <th>Device</th>
              <th>Last seen</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for row in device_rows %}
              <tr>
                <td>{{ row.device.name }}</td>
                <td>
                  {% if row.last_seen %}
                    {{ row.last_seen|date:"M j, Y, g:i a" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  {% if row.status == "online" %}
                    <span class="badge badge-up">online</span>
                  {% else %}
                    <span class="badge badge-down">offline &gt; 1h</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="empty">No devices.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Unwhitelisted APs -->
    <div class="obs-block" style="flex:1 1 360px; min-width:320px;">
      <h3>Unwhitelisted APs (last 10 minutes)</h3>
      <div class="table-wrap">
        <table class="table-tight">
          <thead>
            <tr>
              <th>SSID</th>
              <th>BSSID</th>
              <th>Dev</th>
              <th>Last seen</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% if current_unwhitelisted %}
              {% for o in current_unwhitelisted %}
                <tr>
                  <td>{{ o.ssid|default:"—" }}</td>
                  <td class="mono">{{ o.bssid }}</td>
                  <td>{{ o.device.name }}</td>
                  <td>{{ o.server_ts|date:"M j, Y, g:i a" }}</td>
                  <td><a class="btn-link" href="{% url 'observation_detail' o.id %}">Details</a></td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="5" class="empty">No unwhitelisted APs detected in the last 10 minutes.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- recent alerts below -->
  <div class="obs-block" style="margin-top:14px;">
    <h3>Alert logs / recent observations (latest 20)</h3>
    <div class="table-wrap">
      <table class="table-tight">
        <thead>
          <tr>
            <th>Time</th>
            <th>SSID</th>
            <th>BSSID</th>
            <th>Device</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% if recent_alerts %}
            {% for o in recent_alerts %}
              <tr>
                <td>{{ o.server_ts|date:"M j, Y, g:i a" }}</td>
                <td>{{ o.ssid|default:"—" }}</td>
                <td class="mono">{{ o.bssid }}</td>
                <td>{{ o.device.name }}</td>
                <td><a class="btn-link" href="{% url 'observation_detail' o.id %}">Details</a></td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="5" class="empty">No observations yet.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    <p style="margin:8px 14px 12px; color:var(--muted); font-size:0.7rem;">
      For full filtering and CSV export, go to the <a href="{% url 'observations' %}">Observations</a> page.
    </p>
  </div>
</main>
{% endblock %}
