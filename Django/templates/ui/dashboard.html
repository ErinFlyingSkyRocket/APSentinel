{% extends "base.html" %}
{% block content %}

<main>
  <h1 class="page-title" style="margin-bottom:1rem;">Dashboard</h1>

  <div class="dash-row">
    <!-- Stats block -->
    <div class="obs-block" style="padding:12px;">
      <h3 style="font-size:0.9rem; margin:0 0 8px;">Summary</h3>
      <div class="cards">
        <div class="card">
          <div style="font-size:0.85rem; color:var(--muted); margin-bottom:2px;">
            Observations
          </div>
          <div style="font-size:1.8rem; font-weight:600;">
            {{ total_observations }}
          </div>
        </div>
        <div class="card">
          <div style="font-size:0.85rem; color:var(--muted); margin-bottom:2px;">
            Devices (active ≤ 10 min)
          </div>
          <div style="font-size:1.8rem; font-weight:600;">
            {{ active_devices_count }}
          </div>
        </div>
      </div>
    </div>

    <!-- ESP32 / Sensor devices -->
    <div class="obs-block" style="padding:12px;">
      <h3 style="font-size:0.9rem; margin:0 0 8px;">ESP32 / Sensor devices</h3>

      <div class="table-wrap">
        <table class="table-tight">
          <thead>
            <tr>
              <th>Device</th>
              <th>Last seen</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for d in devices %}
              <tr>
                <td>{{ d.name }}</td>
                <td>
                  {% if d.last_seen %}
                    {{ d.last_seen|date:"M j, Y, g:i a" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  {% if d.is_online %}
                    <span class="badge badge-up">online</span>
                  {% else %}
                    <span class="badge badge-down">offline</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="3" class="empty">No devices registered yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Unwhitelisted APs (last 10 minutes) -->
    <div class="obs-block" style="padding:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h3 style="font-size:0.9rem; margin:0;">Unwhitelisted APs (last 10 minutes)</h3>
        <span style="font-size:0.8rem; color:var(--muted);">
          Total: {{ recent_unwhitelisted_count }}
        </span>
      </div>

      <div class="table-wrap" style="max-height:520px; overflow-y:auto;">
        <table class="table-tight" style="table-layout:fixed;">
          <thead>
            <tr>
              <th>SSID</th>
              <th>BSSID</th>
              <th>Dev</th>
              <th>Last seen</th>
              <th>Ch</th>
              <th>RSSI</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for obs in recent_unwhitelisted %}
              <tr>
                <td class="ellipsis">{{ obs.ssid|default:"<hidden>" }}</td>
                <td class="mono ellipsis">{{ obs.bssid }}</td>
                <td>
                  {% if obs.device %}
                    {{ obs.device.name }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td style="white-space:nowrap;">
                  {{ obs.server_ts|date:"M j, Y, g:i a" }}
                </td>
                <td class="r">{{ obs.channel|default:"-" }}</td>
                <td class="r">
                  {{ obs.rssi_best }}/{{ obs.rssi_cur }}
                </td>
                <td class="r">
                  <a href="{% url 'observation_detail' obs.id %}" class="btn-link">Detail</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="empty">
                  No unwhitelisted APs in the last 10 minutes.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>
</main>

{% endblock %}
