{% extends "base.html" %}
{% block content %}

<main style="padding:1.5rem;">
  <h1 class="page-title" style="font-size:1.4rem; color:#e5e7eb; margin-bottom:1.5rem;">
    Dashboard
  </h1>

  <!-- Single row: Summary + ESP32 devices + Unwhitelisted APs -->
  <div style="display:flex; flex-wrap:wrap; gap:1.25rem;">

    <!-- Summary card -->
    <div style="
        background:#111827;
        border:1px solid #1f2937;
        border-radius:0.75rem;
        padding:1rem 1.25rem;
        flex:1 1 260px;
        min-width:260px;
      ">
      <div style="font-size:0.9rem; font-weight:600; color:#e5e7eb; margin-bottom:0.75rem;">
        Summary
      </div>

      <div style="display:flex; flex-direction:column; gap:0.75rem;">
        <!-- Total observations -->
        <div style="
            background:#020617;
            border:1px solid #1f2937;
            border-radius:0.6rem;
            padding:0.75rem 0.9rem;
          ">
          <div style="font-size:0.85rem; color:#9ca3af; margin-bottom:0.2rem;">
            Observations
          </div>
          <div style="font-size:1.6rem; font-weight:600; color:#e5e7eb;">
            {{ total_obs|default:"0" }}
          </div>
        </div>

        <!-- Active devices -->
        <div style="
            background:#020617;
            border:1px solid #1f2937;
            border-radius:0.6rem;
            padding:0.75rem 0.9rem;
          ">
          <div style="font-size:0.85rem; color:#9ca3af; margin-bottom:0.2rem;">
            Devices (active ≤ 10 min)
          </div>
          <div style="font-size:1.6rem; font-weight:600; color:#e5e7eb;">
            {{ active_device_count|default:"0" }}
          </div>
        </div>
      </div>
    </div>

    <!-- ESP32 / Sensor devices list (from device_rows) -->
    <div style="
        background:#111827;
        border:1px solid #1f2937;
        border-radius:0.75rem;
        padding:1rem 1.25rem;
        flex:1 1 260px;
        min-width:260px;
      ">
      <div style="font-size:0.9rem; font-weight:600; color:#e5e7eb; margin-bottom:0.75rem;">
        ESP32 / Sensor devices
      </div>

      <div style="border-radius:0.5rem; overflow:hidden; border:1px solid #1f2937;">
        <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
          <thead>
            <tr style="background:#020617;">
              <th style="text-align:left; padding:0.4rem 0.6rem; color:#9ca3af; font-weight:500;">Device</th>
              <th style="text-align:left; padding:0.4rem 0.6rem; color:#9ca3af; font-weight:500;">Last seen</th>
              <th style="text-align:left; padding:0.4rem 0.6rem; color:#9ca3af; font-weight:500;">Status</th>
            </tr>
          </thead>
          <tbody>
            {% for row in device_rows %}
              <tr style="background:#020617; border-top:1px solid #1f2937;">
                <td style="padding:0.4rem 0.6rem; color:#e5e7eb; white-space:nowrap;">
                  {{ row.device.name }}
                </td>
                <td style="padding:0.4rem 0.6rem; color:#d1d5db; white-space:nowrap;">
                  {% if row.last_seen %}
                    {{ row.last_seen|date:"M j, Y, g:i a" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td style="padding:0.4rem 0.6rem;">
                  {% if row.status == "online" %}
                    <span style="
                      display:inline-block;
                      padding:0.15rem 0.6rem;
                      font-size:0.75rem;
                      border-radius:9999px;
                      background:#064e3b;
                      color:#bbf7d0;
                    ">
                      online
                    </span>
                  {% else %}
                    <span style="
                      display:inline-block;
                      padding:0.15rem 0.6rem;
                      font-size:0.75rem;
                      border-radius:9999px;
                      background:#1f2937;
                      color:#9ca3af;
                    ">
                      offline
                    </span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="3" style="padding:0.5rem 0.6rem; color:#9ca3af;">
                  No devices registered yet.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Unwhitelisted APs (last 10 minutes) -->
    <div style="
        background:#111827;
        border:1px solid #1f2937;
        border-radius:0.75rem;
        padding:1rem 1.25rem;
        flex:1 1 360px;
        min-width:320px;
      ">
      <div style="
          display:flex;
          justify-content:space-between;
          align-items:center;
          margin-bottom:0.75rem;
        ">
        <div style="font-size:0.9rem; font-weight:600; color:#e5e7eb;">
          Unwhitelisted APs (last 10 minutes)
        </div>
        <div style="font-size:0.8rem; color:#9ca3af;">
          Total: {{ current_unwhitelisted|length }}
        </div>
      </div>

      <div style="
          border-radius:0.5rem;
          border:1px solid #1f2937;
          overflow:hidden;
        ">
        <!-- Scrollable table; show up to ~20 rows before scrolling -->
        <div style="max-height:620px; overflow-y:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:0.8rem; table-layout:fixed;">
            <thead>
              <tr style="background:#020617;">
                <th style="padding:0.45rem 0.6rem; text-align:left; color:#9ca3af; font-weight:500; width:18%; white-space:nowrap;">SSID</th>
                <th style="padding:0.45rem 0.6rem; text-align:left; color:#9ca3af; font-weight:500; width:22%; white-space:nowrap;">BSSID</th>
                <th style="padding:0.45rem 0.6rem; text-align:left; color:#9ca3af; font-weight:500; width:14%; white-space:nowrap;">Dev</th>
                <th style="padding:0.45rem 0.6rem; text-align:left; color:#9ca3af; font-weight:500; width:22%; white-space:nowrap;">Last seen</th>
                <th style="padding:0.45rem 0.6rem; text-align:center; color:#9ca3af; font-weight:500; width:8%;">Ch</th>
                <th style="padding:0.45rem 0.6rem; text-align:center; color:#9ca3af; font-weight:500; width:8%;">RSSI</th>
                <th style="padding:0.45rem 0.6rem; text-align:center; color:#9ca3af; font-weight:500; width:8%;">Details</th>
              </tr>
            </thead>
            <tbody>
              {% for obs in current_unwhitelisted|slice:":20" %}
                <tr style="background:#020617; border-top:1px solid #111827;">
                  <td style="padding:0.4rem 0.6rem; color:#e5e7eb; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    {{ obs.ssid|default:"<hidden>" }}
                  </td>
                  <td style="padding:0.4rem 0.6rem; color:#d1d5db; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    {{ obs.bssid }}
                  </td>
                  <td style="padding:0.4rem 0.6rem; color:#9ca3af; white-space:nowrap;">
                    {% if obs.device %}{{ obs.device.name }}{% else %}—{% endif %}
                  </td>
                  <td style="padding:0.4rem 0.6rem; color:#9ca3af; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    {% if obs.server_ts %}
                      {{ obs.server_ts|date:"M j, Y, g:i a" }}
                    {% elif obs.created_at %}
                      {{ obs.created_at|date:"M j, Y, g:i a" }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td style="padding:0.4rem 0.6rem; color:#d1d5db; text-align:center; white-space:nowrap;">
                    {{ obs.channel|default:"-" }}
                  </td>
                  <td style="padding:0.4rem 0.6rem; color:#d1d5db; text-align:center; white-space:nowrap;">
                    {{ obs.rssi_best }}/{{ obs.rssi_cur }}
                  </td>
                  <td style="padding:0.4rem 0.6rem; text-align:center;">
                    <a href="{% url 'observation_detail' obs.id %}"
                       style="
                         display:inline-block;
                         padding:0.2rem 0.7rem;
                         font-size:0.75rem;
                         border-radius:9999px;
                         background:#1d4ed8;
                         color:#e5e7eb;
                         text-decoration:none;
                       ">
                      Detail
                    </a>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="7" style="padding:0.6rem 0.7rem; color:#9ca3af;">
                    No unwhitelisted APs in the last 10 minutes.
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</main>

{% endblock %}
