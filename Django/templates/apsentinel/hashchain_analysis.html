{% extends "base.html" %}
{% block content %}

<main style="padding:1.5rem;">
  <h1 class="page-title" style="font-size:1.4rem; color:#e5e7eb; margin-bottom:1rem;">ESP32 Evidence Integrity</h1>

  <!-- Filters -->
  <form method="get" style="margin-bottom:1.25rem; display:flex; gap:1rem; flex-wrap:wrap; align-items:flex-end;">

    <!-- Device (typeable dropdown) -->
    <div style="display:flex; flex-direction:column; gap:0.25rem;">
      <label for="device" style="color:#cbd5f5;">Device</label>
      <input list="device-list" name="device" id="device"
             value="{% if selected_device %}{{ selected_device.id }}{% else %}{{ request.GET.device }}{% endif %}"
             placeholder="Type or select device..."
             style="background:#111827; border:1px solid #1f2937; color:#e5e7eb; padding:0.4rem 0.5rem; border-radius:0.4rem; min-width:220px;">
      <datalist id="device-list">
        {% for d in devices %}
          <option value="{{ d.id }}">{{ d.name }}</option>
        {% endfor %}
      </datalist>
      <small style="color:#6b7280; font-size:0.6rem;">Each ESP32 has its own chain</small>
    </div>

    <!-- SSID -->
    <div style="display:flex; flex-direction:column; gap:0.25rem;">
      <label for="ssid" style="color:#cbd5f5;">SSID contains</label>
      <input type="text" name="ssid" id="ssid" value="{{ filter_ssid }}"
             style="background:#111827; border:1px solid #1f2937; color:#e5e7eb; padding:0.4rem 0.5rem; border-radius:0.4rem; min-width:180px;">
    </div>

    <!-- BSSID -->
    <div style="display:flex; flex-direction:column; gap:0.25rem;">
      <label for="bssid" style="color:#cbd5f5;">BSSID</label>
      <input type="text" name="bssid" id="bssid" value="{{ filter_bssid }}"
             placeholder="AA:BB:CC:DD:EE:FF"
             style="background:#111827; border:1px solid #1f2937; color:#e5e7eb; padding:0.4rem 0.5rem; border-radius:0.4rem; min-width:180px;">
    </div>

    <!-- Integrity -->
    <div style="display:flex; flex-direction:column; gap:0.25rem;">
      <label for="integrity" style="color:#cbd5f5;">Integrity</label>
      <select name="integrity" id="integrity"
              style="background:#111827; border:1px solid #1f2937; color:#e5e7eb; padding:0.4rem 0.5rem; border-radius:0.4rem;">
        <option value="all"{% if filter_integrity == "all" %} selected{% endif %}>All</option>
        <option value="ok"{% if filter_integrity == "ok" %} selected{% endif %}>Only OK</option>
        <option value="bad"{% if filter_integrity == "bad" %} selected{% endif %}>Only failed</option>
      </select>
    </div>

    <!-- Since -->
    <div style="display:flex; flex-direction:column; gap:0.25rem;">
      <label for="since" style="color:#cbd5f5;">Since</label>
      <input type="date" name="since" id="since" value="{{ filter_since }}"
             style="background:#111827; border:1px solid #1f2937; color:#e5e7eb; padding:0.3rem 0.4rem; border-radius:0.4rem;">
    </div>

    <!-- Until -->
    <div style="display:flex; flex-direction:column; gap:0.25rem;">
      <label for="until" style="color:#cbd5f5;">Until</label>
      <input type="date" name="until" id="until" value="{{ filter_until }}"
             style="background:#111827; border:1px solid #1f2937; color:#e5e7eb; padding:0.3rem 0.4rem; border-radius:0.4rem;">
    </div>

    <!-- Limit -->
    <div style="display:flex; flex-direction:column; gap:0.25rem; max-width:70px;">
      <label for="limit" style="color:#cbd5f5;">Limit</label>
      <input type="number" name="limit" id="limit"
             value="{% if filter_limit %}{{ filter_limit }}{% else %}100{% endif %}"
             min="1"
             style="background:#111827; border:1px solid #1f2937; color:#e5e7eb; padding:0.3rem 0.4rem; border-radius:0.4rem;">
    </div>

    <div style="display:flex; align-items:flex-end;">
      <button type="submit"
              style="background:#234ea5; border:none; color:white; padding:0.45rem 1.3rem; border-radius:0.4rem; cursor:pointer;">
        Analyze
      </button>
    </div>
  </form>

  {% if selected_device %}
    <!-- summary cards -->
    <div style="display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1.25rem;">
      <div style="background:#111827; border:1px solid #1f2937; border-radius:0.75rem; padding:0.6rem 1rem; min-width:120px;">
        <div style="font-size:0.7rem; color:#9ca3af;">Total records</div>
        <div style="font-size:1.3rem; color:#e5e7eb;">{{ totals.total }}</div>
      </div>
      <div style="background:#111827; border:1px solid #1f2937; border-radius:0.75rem; padding:0.6rem 1rem; min-width:120px;">
        <div style="font-size:0.7rem; color:#9ca3af;">Integrity OK</div>
        <div style="font-size:1.3rem; color:#d1fae5;">{{ totals.ok }}</div>
      </div>
      <div style="background:#111827; border:1px solid #1f2937; border-radius:0.75rem; padding:0.6rem 1rem; min-width:120px;">
        <div style="font-size:0.7rem; color:#9ca3af;">Integrity failed</div>
        <div style="font-size:1.3rem; color:#fecaca;">{{ totals.bad }}</div>
      </div>
    </div>

    <!-- charts -->
    <div style="display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1.5rem;">
      <div style="flex:2 1 360px; background:#111827; border:1px solid #1f2937; border-radius:0.75rem; padding:0.75rem;">
        <h3 style="font-size:0.8rem; margin-bottom:0.4rem; color:#e5e7eb;">Timeline integrity</h3>
        <canvas id="timelineChart" height="120"></canvas>
      </div>
      <div style="flex:1 1 280px; background:#111827; border:1px solid #1f2937; border-radius:0.75rem; padding:0.75rem;">
        <h3 style="font-size:0.8rem; margin-bottom:0.4rem; color:#e5e7eb;">Top BSSIDs seen</h3>
        <canvas id="bssidChart" height="120"></canvas>
      </div>
    </div>

    <!-- table -->
    <div class="table-wrap"
         style="overflow-x:auto; max-height:420px; overflow-y:auto; border-radius:0.75rem;">
      <table style="width:100%; border-collapse:collapse; font-size:0.78rem;">
        <thead>
          <tr style="background:#0f172a; color:#e5e7eb;">
            <th style="text-align:left; padding:0.5rem;">ID</th>
            <th style="text-align:left; padding:0.5rem;">Time</th>
            <th style="text-align:left; padding:0.5rem;">SSID</th>
            <th style="text-align:left; padding:0.5rem;">BSSID</th>
            <th style="text-align:left; padding:0.5rem;">Expected prev</th>
            <th style="text-align:left; padding:0.5rem;">Stored prev</th>
            <th style="text-align:left; padding:0.5rem;">Expected chain</th>
            <th style="text-align:left; padding:0.5rem;">Stored chain</th>
            <th style="text-align:left; padding:0.5rem;">Integrity</th>
          </tr>
        </thead>
        <tbody>
          {% if rows %}
            {% for row in rows %}
            <tr {% if not row.ok %}style="background:#431717;"{% else %}style="background:#0f172a;"{% endif %}>
              <td style="padding:0.4rem 0.5rem; color:#e5e7eb;">{{ row.obs.id }}</td>
              <td style="padding:0.4rem 0.5rem; color:#e5e7eb;">{{ row.obs.server_ts|date:"M j, Y, g:i:s a" }}</td>
              <td style="padding:0.4rem 0.5rem; color:#e5e7eb;">{{ row.obs.ssid|default:"—" }}</td>
              <td style="padding:0.4rem 0.5rem; color:#cbd5f5;" class="mono">{{ row.obs.bssid }}</td>
              <td style="padding:0.4rem 0.5rem; color:#9ca3af;" class="mono">{{ row.expected_prev|slice:":14" }}…</td>
              <td style="padding:0.4rem 0.5rem; color:#9ca3af;" class="mono">{{ row.stored_prev|slice:":14" }}…</td>
              <td style="padding:0.4rem 0.5rem; color:#9ca3af;" class="mono">{{ row.expected_chain|slice:":14" }}…</td>
              <td style="padding:0.4rem 0.5rem; color:#9ca3af;" class="mono">{{ row.stored_chain|slice:":14" }}…</td>
              <td style="padding:0.4rem 0.5rem;">
                {% if row.ok %}
                  <span style="color:#bbf7d0;">✅</span>
                {% else %}
                  <span style="color:#fecaca;">❌</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="9" style="padding:0.6rem; color:#9ca3af; background:#0f172a;">
                No observations matching filters.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if page_obj and paginator %}
      <div style="margin-top:0.75rem; display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap;">
        <div style="display:flex; gap:0.4rem; align-items:center;">
          {% if page_obj.has_previous %}
            <a href="?{% if base_querystring %}{{ base_querystring }}&{% endif %}page={{ page_obj.previous_page_number }}"
               style="padding:0.25rem 0.7rem; border-radius:0.4rem; background:#111827; border:1px solid #1f2937; color:#e5e7eb; text-decoration:none; font-size:0.7rem;">
              ‹ Prev
            </a>
          {% endif %}

          <span style="color:#9ca3af; font-size:0.7rem;">
            Page {{ page_obj.number }} of {{ paginator.num_pages }}
          </span>

          {% if page_obj.has_next %}
            <a href="?{% if base_querystring %}{{ base_querystring }}&{% endif %}page={{ page_obj.next_page_number }}"
               style="padding:0.25rem 0.7rem; border-radius:0.4rem; background:#111827; border:1px solid #1f2937; color:#e5e7eb; text-decoration:none; font-size:0.7rem;">
              Next ›
            </a>
          {% endif %}
        </div>

        <span style="color:#6b7280; font-size:0.65rem;">
          Showing {{ rows|length }} of {{ paginator.count }} records ({{ filter_limit }} per page).
          Use the “Limit” field above to change rows per page.
        </span>
      </div>
    {% endif %}

    <p style="margin-top:0.75rem; color:#fbbf24; font-size:0.65rem;">
      ⚠️ Integrity validation ensures chain-of-custody of ESP32 records — it does not verify Access Point authenticity.
    </p>
  {% else %}
    <p style="color:#6b7280;">Select a device and click “Analyze”.</p>
  {% endif %}
</main>

{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const timelineData = {{ chart_timeline|safe }};
    const bssidData = {{ chart_bssid|safe }};
    const timelineCanvas = document.getElementById('timelineChart');
    if (timelineCanvas && timelineData.length > 0) {
      const ctx = timelineCanvas.getContext('2d');
      const labels = timelineData.map(p => p.ts);
      const values = timelineData.map(p => p.ok ? 1 : 0);
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Integrity (1=OK, 0=Fail)',
            data: values,
            borderColor: '#60a5fa',
            backgroundColor: 'rgba(96,165,250,0.15)',
            tension: 0.25,
            pointRadius: 2,
            pointBackgroundColor: c => c.raw === 1 ? '#22c55e' : '#ef4444'
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#e5e7eb' } } },
          scales: {
            x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,0.1)' } },
            y: { min: 0, max: 1, ticks: { stepSize: 1, color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,0.1)' } }
          }
        }
      });
    }

    const bssidCanvas = document.getElementById('bssidChart');
    if (bssidCanvas && bssidData.length > 0) {
      const ctx2 = bssidCanvas.getContext('2d');
      new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: bssidData.map(p => p.bssid),
          datasets: [{
            label: 'Seen count',
            data: bssidData.map(p => p.count),
            backgroundColor: 'rgba(59,130,246,0.5)',
            borderColor: '#3b82f6'
          }]
        },
        options: {
          indexAxis: 'y',
          plugins: { legend: { labels: { color: '#e5e7eb' } } },
          scales: {
            x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,0.08)' } },
            y: { ticks: { color: '#94a3b8' }, grid: { display:false } }
          }
        }
      });
    }
  </script>
{% endblock %}
